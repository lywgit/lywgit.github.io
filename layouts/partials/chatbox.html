<div id="chatbot-container">
    <div id="chat-window">
    </div>
    <textarea id="user-input" rows="5" maxlength="500" placeholder="Enter message here..."></textarea>
    <button id="send-button">Send</button>
</div>


<style>
    #chat-window {
        height: 450px;
        overflow-y: scroll;
        border: 1px solid #ccc;
        padding: 10px;
    }
    #user-input{
        width: 100%;
        height: 50px;
        overflow-y: scroll;
        padding-left: 5px;
        border: 1px solid #ccc;
        color: rgba(0, 0, 0, 0.747);
    }
    #send-button {
        padding: 7px 10px;
        background-color: rgb(74, 216, 79);
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }
    .user-message {
        text-align: right;
        border-radius: 8px;
        border: 1px solid #ccc;
        padding: 10px;
    }
    .bot-message {
        text-align: left;
        border-radius: 8px;
        border: 1px solid #ccc;
        padding: 10px;
    }
</style>


<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>

    const chatWindow = document.getElementById('chat-window');
    const userInput = document.getElementById('user-input');
    const sendButton = document.getElementById('send-button');
    // const API_ENDPOINT = 'http://127.0.0.1:8000';
    const API_ENDPOINT = 'https://gateway-asia-a331xntq.an.gateway.dev';
    // Send or press Enter to send message
    sendButton.addEventListener('click', sendMessage);

    userInput.addEventListener('keydown', function (e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
    });

    // Render a message and optionally flag it as waiting so we can remove it later
    function displayMessage(sender, message, isWaiting = false) {
        const messageElement = document.createElement('p');
        messageElement.className = sender === 'user' ? 'user-message' : 'bot-message';
        if (isWaiting) messageElement.dataset.waiting = 'true';

        if (sender === 'bot') {
            // Use marked.js to parse Markdown
            messageElement.innerHTML = marked.parse(message);
        } else {
            messageElement.textContent = message;
        }

        chatWindow.appendChild(messageElement);
        // Keep scroll at bottom
        chatWindow.scrollTop = chatWindow.scrollHeight;
        return messageElement;
    }

    // Main function: send message and call API
    async function sendMessage() {
        const userQuery = userInput.value.trim();
        
        if (userQuery === '') return;

        // 1. Display user message
        displayMessage('user', userQuery);
        userInput.value = ''; // Clear input box
        sendButton.disabled = true; // Prevent duplicate sends
        const waitingMessage = 'Waiting for response...';
        displayMessage('bot', waitingMessage, true); // Show waiting message

        try {
            const turnOffFetch = false;
            let botResponse = ""            
            if (turnOffFetch) {
                //mock delay and response
                await new Promise(resolve => setTimeout(resolve, 1000));
                botResponse = "**Faking response** \n For testing."
            }
            else {
                const rag_endpoint = API_ENDPOINT + '/query/rag'
                const response = await fetch(rag_endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // 'Authorization': 'Bearer API_KEY'
                    },
                    body: JSON.stringify({ 
                        query: userQuery,
                        top_k: 10,
                        method: "hybrid"
                    })
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                // Response format: { "answer": "text" }
                botResponse = data.answer || "Sorry, I didn't get a response.";
            }
           
            // remove 'Processing...' message
            const thinkingMessage = chatWindow.querySelector('[data-waiting="true"]');
            if (thinkingMessage) {
                chatWindow.removeChild(thinkingMessage);
            }
            displayMessage('bot', botResponse);

        } catch (error) {
            console.error('API Error:', error);
            // Display error message to user
            const thinkingMessage = chatWindow.querySelector('[data-waiting="true"]');
            if (thinkingMessage) {
                chatWindow.removeChild(thinkingMessage);
            }
            displayMessage('bot', 'Sorry, service is unavailable right now. Please try again later.');
        } finally {
            sendButton.disabled = false; // Restore button
        }
    }
</script>